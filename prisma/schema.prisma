// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model User {
  id          String   @id @default(uuid())
  name        String
  phone       String   @unique
  email       String?  @unique
  role        UserRole
  password    String
  kycStatus   KycStatus @default(PENDING)
  bvn         String?
  nin         String?
  rating      Float    @default(0)
  totalJobs   Int      @default(0)
  isActive    Boolean  @default(true)
  
  // Driver marketplace fields
  isOnline    Boolean  @default(false)
  currentLat  Float?
  currentLng  Float?
  todayEarnings Int    @default(0)
  todayDeliveries Int  @default(0)
  lastLocationUpdate DateTime?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  vehicles    Vehicle[]
  shipper_jobs Job[]    @relation("ShipperJobs")
  carrier_jobs Job[]    @relation("CarrierJobs")
  bids        Bid[]
  ratings     Rating[]  @relation("ReceivedRatings")
  givenRatings Rating[] @relation("GivenRatings")
  documents   Document[]
  trackingPoints TrackingPoint[]
  chatMessages ChatMessage[]
  notifications Notification[]
  payouts Payout[]
}

enum UserRole {
  SHIPPER
  CARRIER
  DRIVER
  BROKER
  ADMIN
}

enum KycStatus {
  PENDING
  VERIFIED
  REJECTED
}

model Vehicle {
  id         String @id @default(uuid())
  ownerId    String
  regNumber  String @unique
  type       VehicleType
  make       String?
  model      String?
  year       Int?
  capacityKg Int
  docs       Json?
  isActive   Boolean @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  
  owner      User   @relation(fields:[ownerId], references:[id], onDelete: Cascade)
  
  @@index([ownerId])
}

enum VehicleType {
  MOTORCYCLE
  VAN
  TRUCK
  PICKUP
}

model Job {
  id              String   @id @default(uuid())
  shipperId       String
  carrierId       String?
  driverId        String?
  pickupAddress   String
  pickupLat       Float
  pickupLng       Float
  dropoffAddress  String
  dropoffLat      Float
  dropoffLng      Float
  distanceKm      Float?
  pricingMode     PricingMode @default(OPEN_BIDS)
  maxBudget       Int?
  computedPrice   Int?
  finalPrice      Int?
  cargoType       String
  cargoWeight     Float?
  cargoDescription String?
  status          JobStatus   @default(POSTED)
  
  // Marketplace fields
  bookingMode     BookingMode @default(AUTO_ACCEPT)
  trackingLink    String?     @unique
  nearbyRadius    Float?      @default(10)
  expiresAt       DateTime?
  
  acceptedAt      DateTime?
  startedAt       DateTime?
  completedAt     DateTime?
  cancelledAt     DateTime?
  cancellationReason String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  shipper         User     @relation("ShipperJobs", fields:[shipperId], references:[id])
  carrier         User?    @relation("CarrierJobs", fields:[carrierId], references:[id])
  bids            Bid[]
  acceptedBidId   String?  @unique
  trackingPoints  TrackingPoint[]
  documents       Document[]
  ratings         Rating[]
  payments        Payment[]
  chatMessages    ChatMessage[]
  
  @@index([shipperId])
  @@index([carrierId])
  @@index([status])
  @@index([createdAt])
  @@index([status, bookingMode, expiresAt])  // Nearby jobs optimization
  @@index([carrierId, status])                // Driver active jobs
  @@index([shipperId, status, createdAt])     // Shipper job history
  @@index([pickupLat, pickupLng])            // Spatial queries
}

enum PricingMode {
  OPEN_BIDS
  INSTANT_PRICE
  NEGOTIABLE
}

enum BookingMode {
  AUTO_ACCEPT  // First driver to accept gets the job (Uber/Bolt style)
  BIDDING      // Multiple drivers bid, shipper chooses (InDrive style)
}


enum JobStatus {
  POSTED
  MATCHED
  IN_TRANSIT
  DELIVERED
  DISPUTED
  CANCELLED
}

model Bid {
  id         String @id @default(uuid())
  jobId      String
  carrierId  String
  driverId   String?
  amount     Int
  etaMinutes Int?
  message    String?
  createdAt  DateTime @default(now())
  status     BidStatus @default(PENDING)
  expiresAt  DateTime?
  
  job        Job  @relation(fields:[jobId], references:[id], onDelete: Cascade)
  carrier    User @relation(fields:[carrierId], references:[id])
  
  @@index([jobId])
  @@index([carrierId])
  @@index([status])
}

enum BidStatus {
  PENDING
  ACCEPTED
  REJECTED
  EXPIRED
}

model TrackingPoint {
  id       String @id @default(uuid())
  jobId    String
  driverId String
  lat      Float
  lng      Float
  speed    Float?
  bearing  Float?
  accuracy Float?
  createdAt DateTime @default(now())
  
  job      Job  @relation(fields:[jobId], references:[id], onDelete: Cascade)
  driver   User @relation(fields:[driverId], references:[id])
  
  @@index([jobId])
  @@index([createdAt])
}

model Payment {
  id              String @id @default(uuid())
  jobId           String
  amount          Int
  platformFee     Int
  carrierAmount   Int
  status          PaymentStatus @default(PENDING)
  paystackRef     String? @unique
  paystackStatus  String?
  paidAt          DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  job             Job  @relation(fields:[jobId], references:[id])
  
  @@index([jobId])
  @@index([paystackRef])
}

enum PaymentStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REFUNDED
}

model Document {
  id          String @id @default(uuid())
  userId      String?
  jobId       String?
  type        DocumentType
  url         String
  fileName    String
  fileSize    Int?
  mimeType    String?
  description String?
  uploadedAt  DateTime @default(now())
  
  user        User? @relation(fields:[userId], references:[id], onDelete: Cascade)
  job         Job?  @relation(fields:[jobId], references:[id], onDelete: Cascade)
  
  @@index([userId])
  @@index([jobId])
}

enum DocumentType {
  NATIONAL_ID
  DRIVERS_LICENSE
  VEHICLE_REGISTRATION
  INSURANCE
  PROOF_OF_DELIVERY
  CARGO_PHOTO
  SIGNATURE
  OTHER
}

model Rating {
  id          String @id @default(uuid())
  jobId       String
  raterId     String
  ratedUserId String
  score       Int
  comment     String?
  createdAt   DateTime @default(now())
  
  job         Job  @relation(fields:[jobId], references:[id])
  rater       User @relation("GivenRatings", fields:[raterId], references:[id])
  ratedUser   User @relation("ReceivedRatings", fields:[ratedUserId], references:[id])
  
  @@index([jobId])
  @@index([ratedUserId])
}

model ChatMessage {
  id        String @id @default(uuid())
  jobId     String
  senderId  String
  message   String
  isRead    Boolean @default(false)
  createdAt DateTime @default(now())
  
  job       Job  @relation(fields:[jobId], references:[id], onDelete: Cascade)
  sender    User @relation(fields:[senderId], references:[id])
  
  @@index([jobId])
  @@index([createdAt])
}

model Dispute {
  id              String @id @default(uuid())
  jobId           String @unique
  reportedBy      String
  reason          String
  description     String
  status          DisputeStatus @default(OPEN)
  resolution      String?
  resolvedBy      String?
  resolvedAt      DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([status])
}

enum DisputeStatus {
  OPEN
  INVESTIGATING
  RESOLVED
  CLOSED
}

model Notification {
  id        String   @id @default(uuid())
  userId    String
  type      NotificationType
  title     String
  message   String
  data      Json?    // Additional context (jobId, bidId, etc.)
  read      Boolean  @default(false)
  createdAt DateTime @default(now())
  
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId, read])
  @@index([createdAt])
}

enum NotificationType {
  JOB_CREATED
  BID_PLACED
  BID_ACCEPTED
  BID_REJECTED
  JOB_STARTED
  JOB_COMPLETED
  JOB_CANCELLED
  PAYMENT_RECEIVED
  PAYOUT_PROCESSED
  PAYOUT_FAILED
  SYSTEM_ALERT
}

model Payout {
  id              String        @id @default(uuid())
  carrierId       String
  amount          Float
  platformFee     Float         @default(0)
  netAmount       Float         // Amount after platform fee
  status          PayoutStatus  @default(PENDING)
  bankName        String?
  accountNumber   String?
  accountName     String?
  reference       String?       @unique
  notes           String?
  initiatedAt     DateTime      @default(now())
  processedAt     DateTime?
  failureReason   String?
  
  carrier         User          @relation(fields: [carrierId], references: [id], onDelete: Cascade)
  
  @@index([carrierId])
  @@index([status])
  @@index([initiatedAt])
}

enum PayoutStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
}
